import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const builtinsDir = path.join(__dirname, '../packages/core/src/builtins');
const outputFile = path.join(__dirname, '../packages/core/src/generated/builtin-bundle.ts');

console.log('[generate-builtin-bundle] Starting...');

// Read primordials and internalBinding
const primordials = fs.readFileSync(path.join(builtinsDir, 'primordials.js'), 'utf8');
const internalBinding = fs.readFileSync(path.join(builtinsDir, 'internalBinding.cjs'), 'utf8');

// Walk Node.js builtin files
const nodeFiles = {};
function walkDir(dir) {
  for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      walkDir(fullPath);
    } else if (entry.name.endsWith('.js')) {
      const relativePath = path.relative(path.join(builtinsDir, 'node'), fullPath);
      nodeFiles[relativePath] = fs.readFileSync(fullPath, 'utf8');
    }
  }
}

const nodeDir = path.join(builtinsDir, 'node');
if (fs.existsSync(nodeDir)) {
  walkDir(nodeDir);
}

// Generate TypeScript module
const output = `// Auto-generated by scripts/generate-builtin-bundle.mjs
// DO NOT EDIT - regenerate with: node scripts/generate-builtin-bundle.mjs

export const builtinSources = {
  'primordials.js': ${JSON.stringify(primordials)},
  'internalBinding.cjs': ${JSON.stringify(internalBinding)}
} as const;

export const nodeBuiltinSources: Record<string, string> = ${JSON.stringify(nodeFiles, null, 2)};
`;

// Ensure output directory exists
fs.mkdirSync(path.dirname(outputFile), { recursive: true });
fs.writeFileSync(outputFile, output);

console.log(`âœ… Generated ${outputFile}`);
console.log(`   - primordials.js: ${(primordials.length / 1024).toFixed(1)}KB`);
console.log(`   - internalBinding.cjs: ${(internalBinding.length / 1024).toFixed(1)}KB`);
console.log(`   - Node.js builtins: ${Object.keys(nodeFiles).length} files`);
